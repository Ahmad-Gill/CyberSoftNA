# trigger:
# - dev

pool:
  vmImage: 'windows-latest' 
variables:
  serverName: 'sqlserverbacpac.database.windows.net'
  databaseName: 'DB-POS-original'
  username: 'bacpacuser'
  password: 'bacpac@12'
  filenamee: 'backup'
  artifactName: 'backup_artifact'
  

steps:

# Step 1: Install SqlPackage
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: 'latest'                                      # Any version starting with 8
    installationPath: $(Agent.ToolsDirectory)/dotnet    #built-in variable in Azure DevOps, which refers to the directory on the build agent where tools are installed.
                                                        #The build agent is the environment that executes all your pipeline tasks.

- script: |
    dotnet tool install -g microsoft.sqlpackage
  displayName: 'Install SqlPackage'

# Step 2: Export database to .bacpac
- script: |
    sqlpackage /Action:Export ^
      /ssn:$(serverName)^
      /sdn:$(databaseName) ^
      /su:$(username) ^
      /sp:$(password) ^
      /tf:$(Build.ArtifactStagingDirectory)\$(filenamee).bacpac
  displayName: 'Export Azure SQL DB to BACPAC'

# Step 3: Publish .bacpac as pipeline artifact
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: '$(artifactName)'
    publishLocation: 'Container'


